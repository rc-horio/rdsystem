# RD Map 空港高さ制限 要件定義書

## 1. 概要

RD Map に「空港高さ制限」機能を追加する。ユーザーが地図上の地点をクリックすると、その地点の高さ制限（○○空港　○○表面　○○ｍ）を吹き出しで表示する。

---

## 2. 対象空港（16空港）

| # | 空港名 | 公式システム名 | データソースURL |
|---|--------|----------------|-----------------|
| 1 | 東京国際空港（羽田空港） | 羽田空港高さ制限回答システム | https://secure.kix-ap.ne.jp/haneda-airport/ |
| 2 | 成田国際空港 | 成田国際空港高さ制限回答システム | https://secure.kix-ap.ne.jp/narita-airport/Temporary/index.html |
| 3 | 大阪国際空港（伊丹空港） | 大阪国際（伊丹）空港高さ制限回答システム | https://secure.kix-ap.ne.jp/itm/ |
| 4 | 関西国際空港 | 関西国際空港高さ制限回答システム | https://secure.kix-ap.ne.jp/kix/ |
| 5 | 中部国際空港（セントレア） | 中部国際空港高さ制限回答システム | https://secure.kix-ap.ne.jp/centrair/Temporary/index.html |
| 6 | 福岡空港 | 福岡空港高さ制限回答システム | https://secure.kix-ap.ne.jp/fukuoka-airport/ |
| 7 | 仙台空港 | 仙台空港高さ制限回答システム | https://secure.kix-ap.ne.jp/sendai-airport/ |
| 8 | 新千歳空港 | 新千歳空港高さ制限回答システム | https://secure.kix-ap.ne.jp/shinchitose-airport/ |
| 9 | 函館空港 | 函館空港高さ制限回答システム | https://secure.kix-ap.ne.jp/hakodate-airport/ |
| 10 | 新潟空港 | 新潟空港高さ制限回答システム | https://secure.kix-ap.ne.jp/niigata-airport/ |
| 11 | 熊本空港 | 熊本空港高さ制限回答システム | https://secure.kix-ap.ne.jp/kumamoto-airport/ |
| 12 | 長崎空港 | 長崎空港高さ制限回答システム | https://secure.kix-ap.ne.jp/nagasaki-airport/ |
| 13 | 那覇空港 | 那覇空港高さ制限回答システム | https://secure.kix-ap.ne.jp/naha-airport/ |
| 14 | 松山空港 | 松山空港高さ制限回答システム | https://secure.kix-ap.ne.jp/matsuyama-airport/ |
| 15 | 宮崎空港 | 宮崎空港高さ制限回答システム | https://secure.kix-ap.ne.jp/miyazaki-airport/ |
| 16 | 八尾空港 | 八尾空港高さ制限回答システム | https://secure.kix-ap.ne.jp/yao-airport/ |

**参考**：羽田空港の操作説明書（PDF）  
https://secure.kix-ap.ne.jp/haneda-airport/howto.pdf

**注意**：利用条件・ライセンスについては「10. ライセンス・運用」を参照。

---

## 3. 操作フロー

### 3.1 モード名（決定）

**「空港高さ制限照会モード」**

- 公式システム（羽田空港高さ制限**照会**システム等）の用語に合わせた名称
- **ボタン表示**：「高さ制限照会」

### 3.2 モードの開始・終了

- **配置**：MapToolsPanel（画面右下）にボタンを追加
- **操作**：ボタンを押すと「空港高さ制限照会モード」に切り替わる
- **ヒント**：モード中は画面にヒントを表示  
  - 文言：「地図をクリックして高さ制限を確認してください」
- **モード終了**：ボタンをもう一度押す、または「キャンセル」ボタン（測定モードと同様にヒント内に配置）、または **Escape キー**

### 3.3 モード中の操作

- **地図クリック**：クリックされた地点の高さ制限を吹き出し（InfoWindow）で表示
- **住所検索**：今は不要（将来の拡張候補）
- **表示形式**：
  - 制限表面内：「○○空港　○○表面　○○ｍ」（高さの単位はメートル）
  - 制限表面外：「制限表面外」
- **吹き出しの挙動**：
  - 閉じるボタン（×）は不要
  - 複数吹き出しは同時表示しない。新しいクリックで前の吹き出しを上書きする
  - クリック位置への一時マーカーは不要。吹き出しのみを `InfoWindow.setPosition()` でクリック位置に表示する

---

## 4. 制限表面の描画

- **描画しない**：空港の制限表面ポリゴンは地図上に描画しない
- **理由**：DJI NFZ が空港の制限区域を内包しているため、重複表示を避ける

---

## 5. DJI NFZ との連携

### 5.1 重複時の表示

- **条件**：DJI NFZ が ON かつ 空港高さ制限照会モード中
- **動作**：クリック地点が DJI NFZ と空港高さ制限の両方に該当する場合、**ひとつの吹き出しにまとめて表示**する
- **DJI NFZ が OFF の場合**：空港高さ制限セクションのみ表示する（DJI NFZ セクションは表示しない）

### 5.2 表示優先順位（決定：案 C）

吹き出し内は**セクション分け**で表示する。

- 「空港高さ制限」と「DJI 飛行禁止区域」を明確に区切る
- 両方の情報が明確に区別され、将来的な拡張がしやすい

**吹き出し例**：
```
■ 空港高さ制限
羽田空港　進入表面　約120m

■ DJI 飛行禁止区域
制限区域（レベル2）
```

---

## 6. 表示内容の詳細

### 6.1 制限表面の種類（表示用ラベル）

| 内部識別 | 表示ラベル |
|----------|------------|
| 着陸帯 | 着陸帯 |
| 進入表面 | 進入表面 |
| 延長進入表面 | 延長進入表面 |
| 転移表面 | 転移表面 |
| 水平表面 | 水平表面 |
| 円錐表面 | 円錐表面 |
| 外側水平表面 | 外側水平表面 |

### 6.2 同一空港内で複数表面に該当する場合

- 1地点が同一空港の複数制限表面に重なる場合（例：進入表面と転移表面の境界付近）、**制限高が最も低い（厳しい）1件のみ表示**する
- 公式システムと同様の挙動とする

### 6.3 複数空港に該当する場合

- 1地点が複数空港の制限表面に重なる場合、**すべての空港・表面・高さを表示**する
- **表示順**：制限高の低い順（厳しい制限を先に表示）

### 6.4 いずれの制限にも該当しない場合

- 空港高さ制限の範囲外かつ DJI NFZ 外をクリックした場合：
  - 「■ 空港高さ制限  制限表面外」のみ表示
  - DJI NFZ セクションは該当なしのため表示しない

### 6.5 高さの精度・単位

- **単位**：メートル（m）
- 参考ソース（羽田）では「約○m」のような概算表示
- 小数点以下は必要に応じて「約」で丸める
- 吹き出しに緯度・経度は表示しない

---

## 7. モバイル・埋め込み対応

- **MapToolsPanel の表示非表示は既存のままでよい**。既存の `useBreakpointMd()`、`detectEmbedMode()` の挙動に従う（変更不要）

---

## 8. 他モードとの競合

- **モードは1つしか ON にできない**（排他モード）
- **空港高さ制限照会モード開始時**：エリア追加・測定・座標変更モードがあれば、それらをキャンセルしてから照会モードを開始する
- **照会モード中**：マーカークリックでは高さ制限を表示し、マーカー選択は行わない

---

## 9. 技術的な前提

### 9.1 データ取得

- 各空港の制限表面データ（座標・計算式）は公式システムのソースコード等を参照
- 羽田空港：提供された JavaScript の座標・計算ロジックを参考に実装可能
- 他15空港：各システムのデータ構造・計算式の調査が必要
- **注意**：那覇空港は「中城湾平均海面」を海抜0mの基準としている。他空港は東京湾平均海面。実装時に標高系の違いを考慮する

### 9.2 既存実装との整合

- RD Map は Google Maps JS API を使用
- 吹き出しは `google.maps.InfoWindow` を使用（DJI NFZ と同様）
- 地図クリックは `map.addListener("click", ...)` で処理

### 9.3 免責表示・公式リンク

- **免責表示**：MapToolsPanel 内に DJI NFZ と同様の disclaimer を追加  
  「高さ制限は参考情報です。正式な照会は公式システムをご利用ください。」
- **公式リンク**：吹き出し内に、該当空港の公式照会システムへのリンクを表示する
  - **リンク文言**：「○○空港 公式照会システム」（例：羽田空港 公式照会システム）
  - 複数空港該当時は複数リンクを表示する

---

## 10. ライセンス・運用

### 10.1 ライセンス（社内システムの場合）

**社内限定利用であれば、多くの場合フォーマルなライセンス契約は不要**です。

ただし、以下は推奨します。

- **画面に免責表示**：「高さ制限は参考情報です。正式な照会は公式システムをご利用ください。」（DJI NFZ と同様）
- **出典の明記**：データソース（各空港の公式システムURL）をドキュメントに残す
- **将来の公開・商用化時**：外部公開や商用利用に変更する場合は、利用条件の再確認が必要

### 10.2 運用方針（個人運用の場合）

現状は1名運用を前提に、最低限の取り決めを以下にまとめます。

| 項目 | 取り決め案 |
|------|------------|
| **データ更新** | 公式システムのURL・構造が変わったとき、または空港側から変更の案内があったときに随時対応 |
| **定期確認** | 年1回程度、主要空港の公式システムが正常に稼働しているか確認（必須ではない） |
| **障害時** | 不具合があれば開発担当者が対応。代替として公式システムへのリンクを案内 |
| **バージョン管理** | 制限表面データを更新した際は、コミットメッセージや CHANGELOG に空港名・更新日を記録 |

運用体制が変わったら、この方針を見直す。

---

## 11. 実装フェーズ

詳細は **実装方針・実装フェーズ**（`airport-height-restriction-implementation-plan.md`）を参照。

| フェーズ | 内容 |
|----------|------|
| **Phase 1** | 羽田空港のみ対応、モード・吹き出し・ヒントの基本実装、DJI NFZ との統合表示（Step 1-1 〜 1-7） |
| **Phase 2** | 他15空港のデータ追加（Step 2-1 〜 2-3） |

---

## 12. エラー・例外処理

| 状況 | 対応 |
|------|------|
| 計算エラー・データ不整合 | 吹き出しに「照会できませんでした」等のメッセージを表示。公式リンクの案内は不要 |
| 該当空港が0件 | 「制限表面外」と表示（6.4 参照） |

### 印刷機能

- **印刷しない**：高さ制限の結果を印刷する機能は不要
